const APP_ID = 'f3d9aeee514b4958bae2a751a01a49e9'

const logError = (message, error) => {
    console.error(`[WebRTC ERROR] ${message}`, error);
    addBotMessageToDom(`B≈ÇƒÖd: ${message}. Sprawd≈∫ konsolƒô dla szczeg√≥≈Ç√≥w.`);
}

let uid = sessionStorage.getItem('uid')
if (!uid) {
    uid = String(Math.floor(Math.random() * 10000))
    sessionStorage.setItem('uid', uid)
}

let token = null;
let client;

let rtmClient;
let channel;

const queryString = window.location.search
const urlParams = new URLSearchParams(queryString)
let roomId = urlParams.get('room')
console.log('Room ID:', roomId);

if (!roomId) {
    roomId = 'main'
}

let displayName = sessionStorage.getItem('display_name')
if (!displayName) {
    displayName = "U≈ºytkownik_" + uid;
    console.warn("Nie znaleziono display_name, u≈ºywam domy≈õlnej warto≈õci:", displayName);
}

let localTracks = []
let remoteUsers = {}

let localScreenTracks;
let sharingScreen = false;
let userIdInDisplayFrame = null;
let displayFrame = document.getElementById('stream__box') || document.createElement('div');


if (!APP_ID) {
    logError("Brak APP_ID. Nale≈ºy ustawiƒá prawid≈Çowy APP_ID z panelu Agora");
}

let joinRoomInit = async () => {
    try {
        console.log("Inicjalizacja po≈ÇƒÖczenia RTM...");
        rtmClient = await AgoraRTM.createInstance(APP_ID)
        await rtmClient.login({ uid, token })
            .catch(error => {
                logError("Nie uda≈Ço siƒô zalogowaƒá do Agora RTM", error);
                throw error;
            });

        await rtmClient.addOrUpdateLocalUserAttributes({ 'name': displayName })
            .catch(error => {
                logError("Nie uda≈Ço siƒô ustawiƒá nazwy u≈ºytkownika", error);
            });

        channel = await rtmClient.createChannel(roomId);
        await channel.join()
            .catch(error => {
                logError(`Nie uda≈Ço siƒô do≈ÇƒÖczyƒá do kana≈Çu ${roomId}`, error);
                throw error;
            });

        console.log("Do≈ÇƒÖczono do kana≈Çu RTM:", roomId);
        
        channel.on('MemberJoined', handleMemberJoined)
        channel.on('MemberLeft', handleMemberLeft)
        channel.on('ChannelMessage', handleChannelMessage)

        getMembers()
        addBotMessageToDom(`Witaj na zajƒôciach ${displayName}! üëã`)

        console.log("Inicjalizacja po≈ÇƒÖczenia RTC...");
        client = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' })
        
        
        client.on("connection-state-change", (curState, prevState) => {
            console.log("Zmiana stanu po≈ÇƒÖczenia:", prevState, "->", curState);
            if (curState === "DISCONNECTED") {
                logError("Po≈ÇƒÖczenie z serwerem zosta≈Ço przerwane", null);
            }
        });

        await client.join(APP_ID, roomId, token, uid)
            .catch(error => {
                logError("Nie uda≈Ço siƒô do≈ÇƒÖczyƒá do RTC", error);
                throw error;
            });

        console.log("Do≈ÇƒÖczono do RTC:", roomId);

        client.on('user-published', handleUserPublished)
        client.on('user-left', handleUserLeft)
        client.on('user-info-updated', (uid, msg) => {
            console.log('Info u≈ºytkownika zaktualizowane:', uid, msg);
        });
        client.on('network-quality', (stats) => {
            console.log('Jako≈õƒá sieci:', stats);
        });

        await joinStream();
    } catch (error) {
        logError("WystƒÖpi≈Ç b≈ÇƒÖd podczas inicjalizacji pokoju", error);
    }
}

let joinStream = async () => {
    try {
        console.log("Pr√≥ba uzyskania dostƒôpu do kamery i mikrofonu...");
        
        
        const devices = await AgoraRTC.getDevices();
        const hasAudio = devices.some(device => device.kind === 'audioinput');
        const hasVideo = devices.some(device => device.kind === 'videoinput');
        
        if (!hasAudio) {
            logError("Nie wykryto mikrofonu w systemie", null);
        }
        
        if (!hasVideo) {
            logError("Nie wykryto kamery w systemie", null);
        }
        
        
        localTracks = await AgoraRTC.createMicrophoneAndCameraTracks(
            { 
                AEC: true, 
                ANS: true 
            }, 
            { 
                encoderConfig: {
                    width: { min: 640, ideal: 1920, max: 1920 },
                    height: { min: 480, ideal: 1080, max: 1080 }
                },
                facingMode: 'user'
            }
        ).catch(error => {
            if (error.code === "PERMISSION_DENIED") {
                logError("Odm√≥wiono dostƒôpu do kamery lub mikrofonu. Sprawd≈∫ uprawnienia przeglƒÖdarki", error);
            } else {
                logError("B≈ÇƒÖd podczas tworzenia strumieni audio/wideo", error);
            }
            throw error;
        });

        
        if (!localTracks[0] || !localTracks[1]) {
            logError("Nie uda≈Ço siƒô uzyskaƒá dostƒôpu do mikrofonu lub kamery", null);
            return;
        }

        console.log("Dostƒôp do kamery i mikrofonu uzyskany pomy≈õlnie");

        let player = `<div class="video__container" id="user-container-${uid}">
                        <div class="video-player" id="user-${uid}"></div>
                     </div>`;

        document.getElementById('streams__container').insertAdjacentHTML('beforeend', player);
        document.getElementById(`user-container-${uid}`).addEventListener('click', expandVideoFrame);

        
        const userVideoElement = document.getElementById(`user-${uid}`);
        if (!userVideoElement) {
            logError(`Nie znaleziono elementu HTML o ID user-${uid}`, null);
            return;
        }

        
        try {
            localTracks[1].play(`user-${uid}`);
            console.log("Lokalne wideo uruchomione");
        } catch (error) {
            logError("Nie uda≈Ço siƒô odtworzyƒá lokalnego strumienia wideo", error);
        }

        
        try {
            await client.publish([localTracks[0], localTracks[1]]);
            console.log("Lokalne strumienie opublikowane pomy≈õlnie");
        } catch (error) {
            logError("Nie uda≈Ço siƒô opublikowaƒá strumieni lokalnych", error);
        }

        
        let cameraBtn = document.getElementById('camera-btn');
        if (cameraBtn) {
            cameraBtn.classList.remove('active');
        }
    } catch (error) {
        logError("WystƒÖpi≈Ç b≈ÇƒÖd podczas do≈ÇƒÖczania do strumienia", error);
    }
}

let switchToCamera = async () => {
    try {
        let player = `<div class="video__container" id="user-container-${uid}">
                        <div class="video-player" id="user-${uid}"></div>
                     </div>`;
        displayFrame.insertAdjacentHTML('beforeend', player);

        await localTracks[0].setMuted(true);
        await localTracks[1].setMuted(true);

        const micBtn = document.getElementById('mic-btn');
        const screenBtn = document.getElementById('screen-btn');
        
        if (micBtn) micBtn.classList.remove('active');
        if (screenBtn) screenBtn.classList.remove('active');

        try {
            localTracks[1].play(`user-${uid}`);
            console.log("Prze≈ÇƒÖczono na kamerƒô");
        } catch (error) {
            logError("Nie uda≈Ço siƒô odtworzyƒá lokalnego strumienia wideo po prze≈ÇƒÖczeniu", error);
        }

        try {
            await client.publish([localTracks[1]]);
            console.log("Opublikowano strumie≈Ñ kamery");
        } catch (error) {
            logError("Nie uda≈Ço siƒô opublikowaƒá strumienia kamery", error);
        }
    } catch (error) {
        logError("WystƒÖpi≈Ç b≈ÇƒÖd podczas prze≈ÇƒÖczania na kamerƒô", error);
    }
}

let handleUserPublished = async (user, mediaType) => {
    try {
        console.log(`U≈ºytkownik ${user.uid} opublikowa≈Ç strumie≈Ñ typu: ${mediaType}`);
        remoteUsers[user.uid] = user;

        try {
            await client.subscribe(user, mediaType);
            console.log(`Zasubskrybowano do u≈ºytkownika ${user.uid}, typ medi√≥w: ${mediaType}`);
        } catch (error) {
            logError(`Nie uda≈Ço siƒô zasubskrybowaƒá do u≈ºytkownika ${user.uid} (${mediaType})`, error);
            return;
        }

        let player = document.getElementById(`user-container-${user.uid}`);
        if (player === null) {
            player = `<div class="video__container" id="user-container-${user.uid}">
                    <div class="video-player" id="user-${user.uid}"></div>
                </div>`;

            document.getElementById('streams__container').insertAdjacentHTML('beforeend', player);
            document.getElementById(`user-container-${user.uid}`).addEventListener('click', expandVideoFrame);
        }

        if (mediaType === 'video') {
            try {
                user.videoTrack.play(`user-${user.uid}`);
                console.log(`Odtwarzanie wideo u≈ºytkownika ${user.uid}`);
            } catch (error) {
                logError(`Nie uda≈Ço siƒô odtworzyƒá wideo u≈ºytkownika ${user.uid}`, error);
            }
        }

        if (mediaType === 'audio') {
            try {
                user.audioTrack.play();
                console.log(`Odtwarzanie audio u≈ºytkownika ${user.uid}`);
            } catch (error) {
                logError(`Nie uda≈Ço siƒô odtworzyƒá audio u≈ºytkownika ${user.uid}`, error);
            }
        }
    } catch (error) {
        logError(`WystƒÖpi≈Ç b≈ÇƒÖd podczas obs≈Çugi publikacji u≈ºytkownika ${user.uid}`, error);
    }
}

let handleUserLeft = async (user) => {
    try {
        console.log(`U≈ºytkownik ${user.uid} opu≈õci≈Ç pok√≥j`);
        delete remoteUsers[user.uid];
        
        const userContainer = document.getElementById(`user-container-${user.uid}`);
        if (userContainer) {
            userContainer.remove();
        } else {
            console.warn(`Nie znaleziono kontenera dla u≈ºytkownika ${user.uid}`);
        }

        if (userIdInDisplayFrame === `user-container-${user.uid}`) {
            displayFrame.style.display = null;

            let videoFrames = document.getElementsByClassName('video__container');
            for (let i = 0; i < videoFrames.length; i++) {
                videoFrames[i].style.height = '300px';
                videoFrames[i].style.width = '300px';
            }
        }

        try {
            await client.publish([localTracks[0], localTracks[1]]);
        } catch (error) {
            logError("Nie uda≈Ço siƒô opublikowaƒá lokalnych strumieni po wyj≈õciu u≈ºytkownika", error);
        }
    } catch (error) {
        logError(`WystƒÖpi≈Ç b≈ÇƒÖd podczas obs≈Çugi wyj≈õcia u≈ºytkownika ${user.uid}`, error);
    }
}

let toggleMic = async (e) => {
    try {
        let button = e.currentTarget;

        if (!localTracks[0]) {
            logError("Mikrofon nie jest dostƒôpny", null);
            return;
        }

        if (localTracks[0].muted) {
            await localTracks[0].setMuted(false);
            button.classList.add('active');
            console.log("Mikrofon w≈ÇƒÖczony");
        } else {
            await localTracks[0].setMuted(true);
            button.classList.remove('active');
            console.log("Mikrofon wyciszony");
        }
    } catch (error) {
        logError("WystƒÖpi≈Ç b≈ÇƒÖd podczas prze≈ÇƒÖczania mikrofonu", error);
    }
}

let toggleCamera = async (e) => {
    try {
        let button = e.currentTarget;

        if (!localTracks[1]) {
            logError("Kamera nie jest dostƒôpna", null);
            return;
        }

        if (localTracks[1].muted) {
            await localTracks[1].setMuted(false);
            button.classList.add('active');
            console.log("Kamera w≈ÇƒÖczona");
        } else {
            await localTracks[1].setMuted(true);
            button.classList.remove('active');
            console.log("Kamera wy≈ÇƒÖczona");
        }
    } catch (error) {
        logError("WystƒÖpi≈Ç b≈ÇƒÖd podczas prze≈ÇƒÖczania kamery", error);
    }
}

let toggleScreen = async (e) => {
    try {
        let screenButton = e.currentTarget;
        let cameraButton = document.getElementById('camera-btn');

        if (!sharingScreen) {
            sharingScreen = true;

            screenButton.classList.add('active');
            cameraButton.classList.remove('active');
            cameraButton.style.display = 'none';

            try {
                localScreenTracks = await AgoraRTC.createScreenVideoTrack();
                console.log("Utworzono strumie≈Ñ udostƒôpniania ekranu");
            } catch (error) {
                if (error.code === "PERMISSION_DENIED") {
                    logError("Odm√≥wiono dostƒôpu do udostƒôpniania ekranu", error);
                } else {
                    logError("Nie uda≈Ço siƒô utworzyƒá strumienia udostƒôpniania ekranu", error);
                }
                sharingScreen = false;
                screenButton.classList.remove('active');
                cameraButton.style.display = 'block';
                return;
            }

            const userContainer = document.getElementById(`user-container-${uid}`);
            if (userContainer) {
                userContainer.remove();
            }
            
            displayFrame.style.display = 'block';

            let player = `<div class="video__container" id="user-container-${uid}">
                        <div class="video-player" id="user-${uid}"></div>
                    </div>`;

            displayFrame.insertAdjacentHTML('beforeend', player);
            document.getElementById(`user-container-${uid}`).addEventListener('click', expandVideoFrame);

            userIdInDisplayFrame = `user-container-${uid}`;
            
            try {
                localScreenTracks.play(`user-${uid}`);
                console.log("Odtwarzanie udostƒôpniania ekranu");
            } catch (error) {
                logError("Nie uda≈Ço siƒô odtworzyƒá strumienia udostƒôpniania ekranu", error);
            }

            try {
                await client.unpublish([localTracks[1]]);
                await client.publish([localScreenTracks]);
                console.log("Opublikowano strumie≈Ñ udostƒôpniania ekranu");
            } catch (error) {
                logError("Nie uda≈Ço siƒô opublikowaƒá strumienia udostƒôpniania ekranu", error);
            }

            let videoFrames = document.getElementsByClassName('video__container');
            for (let i = 0; i < videoFrames.length; i++) {
                if (videoFrames[i].id != userIdInDisplayFrame) {
                    videoFrames[i].style.height = '100px';
                    videoFrames[i].style.width = '100px';
                }
            }
        } else {
            sharingScreen = false;
            cameraButton.style.display = 'block';
            
            const userContainer = document.getElementById(`user-container-${uid}`);
            if (userContainer) {
                userContainer.remove();
            }

            try {
                await client.unpublish([localScreenTracks]);
                console.log("Zako≈Ñczono publikacjƒô udostƒôpniania ekranu");
            } catch (error) {
                logError("Nie uda≈Ço siƒô zako≈Ñczyƒá publikacji udostƒôpniania ekranu", error);
            }

            await switchToCamera();
        }
    } catch (error) {
        logError("WystƒÖpi≈Ç b≈ÇƒÖd podczas prze≈ÇƒÖczania udostƒôpniania ekranu", error);
    }
}

let leaveChannel = async () => {
    try {
        for (let i = 0; localTracks.length > i; i++) {
            if (localTracks[i]) {
                localTracks[i].stop();
                localTracks[i].close();
            }
        }

        if (localScreenTracks) {
            localScreenTracks.stop();
            localScreenTracks.close();
        }

        await client.leave();
        await channel.leave();
        await rtmClient.logout();
        
        console.log("Opuszczono pok√≥j");
        return true;
    } catch (error) {
        logError("WystƒÖpi≈Ç b≈ÇƒÖd podczas opuszczania pokoju", error);
        return false;
    }
}

let leaveChannelAndGoToLobby = async () => {
    const success = await leaveChannel();
    if (success) {
        window.location = '/strefa-wiedzy/';
    }
}

let expandVideoFrame = (e) => {
    
    try {
        let child = e.currentTarget;
        if (!displayFrame) {
            console.warn("Element displayFrame nie istnieje");
            return;
        }

        if (child.id === userIdInDisplayFrame) {
            document.getElementById(child.id).style.height = '300px';
            document.getElementById(child.id).style.width = '300px';
            
            userIdInDisplayFrame = null;
            displayFrame.style.display = 'none';

            let videoFrames = document.getElementsByClassName('video__container');
            for (let i = 0; i < videoFrames.length; i++) {
                videoFrames[i].style.height = '300px';
                videoFrames[i].style.width = '300px';
            }
            return;
        }

        userIdInDisplayFrame = child.id;
        displayFrame.style.display = 'block';
        displayFrame.innerHTML = '';
        
        document.getElementById(child.id).style.height = '100%';
        document.getElementById(child.id).style.width = '100%';
        
        child.appendChild(document.getElementById('stream__box'));
        
        let videoFrames = document.getElementsByClassName('video__container');
        for (let i = 0; i < videoFrames.length; i++) {
            if (videoFrames[i].id !== userIdInDisplayFrame) {
                videoFrames[i].style.height = '100px';
                videoFrames[i].style.width = '100px';
            }
        }
    } catch (error) {
        logError("WystƒÖpi≈Ç b≈ÇƒÖd podczas rozszerzania ramki wideo", error);
    }
}


let getMembers = async () => {
    try {
        let members = await channel.getMembers();
        console.log('Cz≈Çonkowie kana≈Çu:', members);
        return members;
    } catch (error) {
        logError("Nie uda≈Ço siƒô pobraƒá listy cz≈Çonk√≥w kana≈Çu", error);
        return [];
    }
}


let handleMemberJoined = async (memberId) => {
    console.log("Nowy u≈ºytkownik do≈ÇƒÖczy≈Ç:", memberId);
    
}

let handleMemberLeft = async (memberId) => {
    console.log("U≈ºytkownik opu≈õci≈Ç pok√≥j:", memberId);
    
}

let handleChannelMessage = async (messageData, memberId) => {
    console.log("Otrzymano wiadomo≈õƒá:", messageData, "od:", memberId);
    
}


let addBotMessageToDom = (message) => {
    const messageContainer = document.getElementById('messages__container') || document.createElement('div');
    
    let newMessage = `<div class="message__wrapper">
                        <div class="message__body__bot">
                            <strong class="message__author">ü§ñ Bot</strong>
                            <p class="message__text">${message}</p>
                        </div>
                    </div>`;
                    
    messageContainer.insertAdjacentHTML('beforeend', newMessage);
    
    
    messageContainer.scrollTop = messageContainer.scrollHeight;
}


document.addEventListener('DOMContentLoaded', () => {
    console.log("Strona za≈Çadowana, sprawdzanie dostƒôpno≈õci element√≥w UI...");
    
    const elementsToCheck = [
        'camera-btn', 
        'mic-btn', 
        'screen-btn', 
        'leave-btn', 
        'streams__container',
        'stream__box',
        'messages__container'
    ];
    
    elementsToCheck.forEach(id => {
        const element = document.getElementById(id);
        if (!element) {
            console.warn(`Nie znaleziono elementu HTML o ID ${id}`);
        }
    });
    
    
    const cameraBtn = document.getElementById('camera-btn');
    const micBtn = document.getElementById('mic-btn');
    const screenBtn = document.getElementById('screen-btn');
    const leaveBtn = document.getElementById('leave-btn');
    
    if (cameraBtn) cameraBtn.addEventListener('click', toggleCamera);
    if (micBtn) micBtn.addEventListener('click', toggleMic);
    if (screenBtn) screenBtn.addEventListener('click', toggleScreen);
    if (leaveBtn) leaveBtn.addEventListener('click', leaveChannelAndGoToLobby);
    
    displayFrame = document.getElementById('stream__box') || document.createElement('div');
});


if (document.readyState === 'complete') {
    joinRoomInit();
} else {
    window.addEventListener('load', joinRoomInit);
}